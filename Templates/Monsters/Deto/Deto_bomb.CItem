o.Mesh = "polySurfaceShape234"
o.Pack = "granat.dat"
o.Scale = 0.3
o.Health = 1
o.forceOut = 80				-- sila explozji na boki
o.forceUp =	550				-- sila explozji do gory
o.timeToLive = 70		 	-- w sec.
o.Friction = 0.5
o.flySpeed = 1000

o.flame_FX = "firework"
o.flame_FXscale = 0.5
o.explosion_FX = "firework_explo"
o.explosion_FXscale = 0.4

o.ExplosionStrength = 2000
o.ExplosionRange = 6
o.Damage = 30

function o:OnPrecache()
--    Cache:PrecacheParticleFX(self.flame_FX)
--    Cache:PrecacheParticleFX(self.explosion_FX)
end

function o:OnCreateEntity()
	self:PO_Create(BodyTypes.FromMesh,nil,ECollisionGroups.InsideItems)
	--ENTITY.PO_SetLinearDamping(self._Entity, 0.1)

    --ENTITY.EnableCollisions(self._Entity,true,0.3,0.01)

	ENTITY.PO_SetMovedByExplosions(self._Entity, false)			-- ?
	self._TimeToLive = self.timeToLive * FRand(0.8, 1.2)

	--ENTITY.SetAngularVelocity(self._Entity, FRand(12, 15), FRand(0, 2), FRand(0, 2)) 
	self:AddTimer("Detonate",self.timeToLive)
end

function o:Detonate()
	local x,y,z = self.Pos.X,self.Pos.Y,self.Pos.Z
	ENTITY.EnableCollisions(self._Entity,false) -- disable next callbacks        
	ENTITY.PO_Enable(self._Entity,false)

	WORLD.Explosion2(x,y,z,self.ExplosionStrength,self.ExplosionRange,nil,AttackTypes.Grenade,self.Damage)  
	self:Client_Explosion(x,y,z)

	GObjects:ToKill(self)
end

o.CustomOnDeath = o.Detonate

function o:Client_Explosion(x,y,z)
    ENTITY.PO_Enable(entity,false)
    
    -- special FX
    SOUND.Play3D("actor/maso/maso_grenade-explosion",x,y,z,12)
    AddPFX("Grenade",0.6,Vector:New(x,y,z))            
    
    -- physical parts
    --[[local n = math.random(1,2) -- how many (min,max)
    local scales = {0.6, 0.8}
    for i = 1, n do
        local scale = scales[math.random(1,2)]
        local ke = AddItem("KamykWybuch.CItem",scale,Vector:New(x,y+0.5+i/10,z),false,Quaternion:New_FromEuler(FRand(0,3.14), FRand(0,3.14), FRand(0,3.14)))
        local vx = FRand(-20,30) -- velocity x
        local vy = FRand(15,30)  -- velocity y
        local vz = FRand(-20,30) -- velocity z
        ENTITY.SetVelocity(ke,vx,vy,vz)
        ENTITY.SetTimeToDie(ke,FRand(1,2)) -- lifetime (min,max)
    end--]]

    -- light
    AddAction({{"Light:a[1],a[2],a[3],200,200,100, 8, 10 , 1, 0.02,0.1,0.02"}},nil,nil,x,y+1.5,z)
    if Game._EarthQuakeProc then
        Game._EarthQuakeProc:Add(x,y,z, 12, 10 --[[g.ExplosionCamDistance--]], 0.25, 0.25)
    end
end

-- #### po jakims czasie col. normal?